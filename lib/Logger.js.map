{"version":3,"sources":["../src/Logger.js"],"names":["Logger","url","maxBufferLength","automaticFlush","overwriteBuffer","fetchConfig","sessionIdRequired","__send__","fireOnGlobalErrors","interval","Error","extraParams","flush","bind","buffer","hooks","timer","registerErrorHandler","log","state","level","extra","isFull","shift","push","timestamp","Date","now","action","window","addEventListener","_bufferUp","start","id","sessionId","undefined","key","value","message","method","body","JSON","stringify","headers","hook","forEach","getBuffer","logs","length","Promise","resolve","config","getFetchConfig","runHooks","report"],"mappings":"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","file":"Logger.js","sourcesContent":["import fetch from 'isomorphic-fetch';\n\nimport Buffer from './Buffer';\nimport Timer from './Timer';\n\n\nclass Logger {\n    constructor({\n        url,\n        maxBufferLength = 100,\n        automaticFlush = true,\n        overwriteBuffer = true,\n        fetchConfig = {},\n        sessionIdRequired = true,\n        __send__,\n        fireOnGlobalErrors = true,\n        interval, // if interval is not set (  ), timer will not start\n    }) {\n        if (!(this instanceof Logger)) { return new Logger({}); }\n        if (typeof url === 'undefined' && typeof __send__ === 'undefined') {\n            throw new Error('either set url or __send__');\n        }\n\n        this.maxBufferLength = maxBufferLength;\n        this.automaticFlush = automaticFlush;\n        this.overwriteBuffer = overwriteBuffer;\n        this.interval = interval;\n        this.fetchConfig = fetchConfig;\n        this.url = url;\n        this.sessionIdRequired = sessionIdRequired;\n        this.extraParams = {};\n        this.flush = this.flush.bind(this);\n\n        // eslint-disable-next-line no-buffer-constructor\n        this.buffer = new Buffer(maxBufferLength);\n        this.hooks = [];\n        this.timer = new Timer(this.flush, interval);\n\n        if (fireOnGlobalErrors) this.registerErrorHandler();\n        if (__send__ && typeof __send__ === 'function') this.__send__ = __send__;\n    }\n\n    _bufferUp(log, state, level, extra) {\n        const {\n            buffer,\n            overwriteBuffer,\n        } = this;\n\n        if (buffer.isFull()) {\n            // if overwriteBuffer set to false, silently drop all new logs\n            if (overwriteBuffer) buffer.shift();\n        }\n\n        if (log) {\n            buffer.push({\n                timestamp: Date.now(),\n                state,\n                extra,\n                level,\n                action: log,\n            });\n        }\n    }\n\n    registerErrorHandler() {\n        if (typeof window !== 'undefined') {\n            window.addEventListener('error', () => {\n                this.flush();\n            });\n        }\n    }\n\n    report(level, log, state) {\n        const {\n            automaticFlush,\n            interval,\n            buffer,\n            extraParams,\n        } = this;\n        this._bufferUp(log, state, level, extraParams);\n        if (automaticFlush) {\n            if (buffer.isFull()) {\n                this.flush();\n            } else if (interval) {\n                this.timer.start();\n            }\n        }\n    }\n\n    setSessionId(id) {\n        this.sessionId = id;\n        return this;\n    }\n\n    unsetSessionId() {\n        this.sessionId = undefined;\n    }\n\n    setExtraParams(key, value) {\n        if (!key) throw new Error('Key is undefined');\n        this.extraParams[key] = value;\n    }\n\n    getFetchConfig(message) {\n        return {\n            method: 'POST',\n            body: JSON.stringify({\n                message,\n                sessionId: this.sessionId,\n            }),\n            headers: {\n                'Content-Type': 'application/json',\n            },\n            ...this.fetchConfig,\n        };\n    }\n    // these will be called before sending logs\n    addHook(hook) {\n        if (typeof hook !== 'function') throw new Error('Invalid Hook');\n        this.hooks.push(hook);\n        return this;\n    }\n\n    runHooks() {\n        this.hooks.forEach(hook => hook(this.buffer.getBuffer(), this.sessionId));\n    }\n\n    flush() {\n        if (!this.sessionIdRequired || this.sessionId) {\n            const logs = this.buffer.getBuffer();\n            if (logs.length === 0) return Promise.resolve('No logs to send');\n            const config = this.getFetchConfig(logs);\n            this.runHooks();\n            this.buffer.flush();\n            if (this.__send__) return Promise.resolve(this.__send__(logs, this.sessionId));\n            return fetch(this.url, config);\n        }\n        return Promise.resolve('Required sessionId not set');\n    }\n\n    info(log, state) { this.report('info', log, state); }\n    warn(log, state) { this.report('warn', log, state); }\n    error(log, state) { this.report('error', log, state); }\n    debug(log, state) { this.report('debug', log, state); }\n    emerg(log, state) { this.report('emerg', log, state); }\n}\n\nexport default Logger;\n"]}